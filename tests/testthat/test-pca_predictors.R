set.seed(1)
test_that("pca_predictors - normal path", {
  sa <- sdm_area(parana, 1)
  sa <- add_predictors(sa, bioc)
  sa <- select_predictors(sa, c("bio1", "bio12"))
  sa <- sa |> dplyr::mutate(div=bio1/bio12, prod=bio1*bio12, sub=bio12-bio1, soma=bio1+bio12)
  sa <- add_scenarios(sa)
  oc <- occurrences_sdm(occ, crs=6933)
  expect_warning(oc <- join_area(oc, sa))
  i <- input_sdm(oc, sa)
  i <- pca_predictors(i)
  expect_true("variable_selection" %in% names(i$predictors))
  expect_true("pca" %in% names(i$predictors$variable_selection))
  expect_true(any(get_predictor_names(i)[-c(1:6)] %in% i$predictors$variable_selection$pca$selected_variables))
  expect_true(all(get_predictor_names(i)[-c(1:6)] %in% colnames(i$scenarios$data$current)))
  #skip_on_cran()
  #expect_snapshot(pca_summary(i))
  val <- pca_summary(i)
  expect_equal(val$importance[,1] |> as.numeric() |> round(4), c(592.9990, 0.9951, 0.9951))
  expect_equal(val$sdev |> round(3), c(592.999, 41.689, 0.244, 0.000, 0.000, 0.000))
  expect_equal(as.numeric(val$rotation[,1]) |> round(4), c(-0.0016, -0.0263,  0.0000, -0.9990, -0.0248, -0.0279))
  expect_equal(as.numeric(val$x[1,]) |> round(4), c(-53.6178,  70.4353,  0.4051,  -0.0001 ,  0.0000  , 0.0000))
  expect_equal(as.numeric(val$center) |> round(3), c( 19.191,  300.912 ,   0.065, 5752.281,  281.721,  320.103))
})

test_that("pca_predictors - without scenarios", {
  sa <- sdm_area(parana, 1)
  sa <- add_predictors(sa, bioc)
  sa <- select_predictors(sa, c("bio1", "bio12"))
  sa <- sa |> dplyr::mutate(div=bio1/bio12, prod=bio1*bio12, sub=bio12-bio1, soma=bio1+bio12)
  oc <- occurrences_sdm(occ, crs=6933)
  expect_warning(oc <- join_area(oc, sa))
  i <- input_sdm(oc, sa)
  i <- pca_predictors(i)
  expect_true("variable_selection" %in% names(i$predictors))
  expect_true("pca" %in% names(i$predictors$variable_selection))
  expect_true(any(get_predictor_names(i)[-c(1:6)] %in% i$predictors$variable_selection$pca$selected_variables))
  expect_true(all(get_predictor_names(i)[-c(1:6)] %in% colnames(i$scenarios$data$current)))
  #skip_on_cran()
  #expect_snapshot(pca_summary(i))
  val <- pca_summary(i)
  expect_equal(val$importance[,1] |> as.numeric() |> round(4), c(592.9990, 0.9951, 0.9951))
  expect_equal(val$sdev |> round(3), c(592.999, 41.689, 0.244, 0.000, 0.000, 0.000))
  expect_equal(as.numeric(val$rotation[,1]) |> round(4), c(-0.0016, -0.0263,  0.0000, -0.9990, -0.0248, -0.0279))
  expect_equal(as.numeric(val$x[1,]) |> round(4), c(-53.6178,  70.4353,  0.4051,  -0.0001 ,  0.0000  , 0.0000))
  expect_equal(as.numeric(val$center) |> round(3), c( 19.191,  300.912 ,   0.065, 5752.281,  281.721,  320.103))
})
