---
title: "Using lines as study_area in caretSDM"
author: "Luíz Fernando Esser"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Salminus}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`caretSDM` is a under development R package that uses the powerful `caret` package as the main engine to obtain Species Distribution Models. One of its main attributes is the strong geoprocessing underlying its functions. Here we show how to model species distributions using `caretSDM` through the function `sdm_area` with lines instead of polygons. This is implemented mostly thinking in HydroSHEDS database, which is particularly important for continental aquatic environments modeling. We also show how to avoid multicolinearity using a Variance Inflation Factor (VIF) routine. The aim of this modeling will be to obtain the current distribution of *Salminus brasiliensis*, a economically and ecologically key fish species from Paraná-Paraguay watershed.

```{r open libraries}
library(caretSDM)
library(stars) # Package used to manipulate GIS data
library(dplyr) # Package to improve data handling
#library(progressr) # Package to show progress bars
#progressr::handlers(global = TRUE)
```

### Obtaining climatic data

We will first download and import current data, which is used to build and project the models. `WorldClim_data` function has an argument to set the directory in which you want to save the files. If you don't set it, files will be saved in your working directory (run `getwd()` to find out your working dirrectory) in the folder "input_data/WorldClim_data_current/". We could run this script with a smaller resolution, but as the aim here is to show how the package works, we will use a resolution of 10 arc-minutes, which is very coarse, but quicker to download and run.

```{r GBIF_data}
# Import data from GBIF
occ_data <- GBIF_data('Salminus brasiliensis')
```

```{r}
## Download current bioclimatic variables
WorldClim_data(period = "current", resolution = 10)

## Enter bioclimatic variables
pred_data <- read_stars(list.files("input_data/WorldClim_data_current/", full.names = T), along = "band", normalize_path = F)
```

```{r study_area}
study_area <- st_read('input_data/parana_paraguay.gpkg')
```

```{r create_buffer}
buf <- st_as_sf(occ_data, coords=c(2,3))
st_crs(buf) <- 4326
buf <- st_crop(buf, study_area)
buf <- st_buffer(buf, dist=5)
buf <- st_union(buf)
```

```{r sdm_area}
sa <- sdm_area(study_area, cell_size = 25000, crs = 6933, gdal = T)
```

```{r add_predictors}
get_predictor_names(sa)
sa <- add_predictors(sa, pred_data, gdal = T)
get_predictor_names(sa)
```

```{r}
sa <- add_scenarios(sa)
```

```{r input_sdm}
i <- input_sdm(occurrences_sdm(occ_data, crs = 4326), sa)
i
```

```{r data_clean}
# funciona
i <- data_clean(i, terrestrial = FALSE)
i
```

```{r vif_predictors}
i <- vif_predictors(i)
i
```

```{r pseudoabsence}
i <- pseudoabsences(i, method = "bioclim", variables_selected = "vif") 
i
```

```{r train_sdm, eval=TRUE, include=FALSE}
i <- train_sdm(i, algo = c("svmLinear2", "mda", "nnet", "kknn"), variables_selected = "vif")
```

```{r train_sdm2, eval=FALSE, include=TRUE}
i <- train_sdm(i, algo = c("svmLinear2", "mda", "nnet", "kknn"), variables_selected = "vif")
```

```{r}
i
```

```{r predict_sdm}
i <- predict_sdm(i, th = 0.85)
```

```{r plot_predictions}
plot_predictions(i, scenario = "current")
```

```{r pdp_sdm}
pdp_sdm(i)
```

```{r varImp_sdm}
varImp_sdm(i)
```
