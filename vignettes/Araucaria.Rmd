---
title: "Araucaria"
author: "LuÃ­z Fernando Esser"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Araucaria}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Using polygons as area in caretSDM

`caretSDM` is a under development R package that uses the powerful `caret` package as the main engine to obtain Species Distribution Models. One of its main attributes is the strong geoprocessing underlying its functions. Here we show how to model species distributions using `caretSDM` through the function `sdm_area` with a polygon.

```{r open libraries}
#library(chooseGCM)
library(caretSDM)
library(stars)
library(dplyr)
```

## Pre-Processing

### Obtaining example data

We will create some example data. Starting with occurrences and then predictors data. The first one is a function to obtain species data from GBIF, while the second is a function to obtain climatic variables from WorldClim 2.1. You can read more about them by running in the console `?GBIF_data` and `?WorldClim_data`.

```{r GBIF_data}
# Import data from GBIF
occ_data <- GBIF_data('Araucaria angustifolia')

# Remove records from outside the natural occurrence area
occ_data <- filter(occ_data, decimalLongitude >= -64)
occ_data <- filter(occ_data, decimalLongitude <= -36)
occ_data <- filter(occ_data, decimalLatitude <= -10)
occ_data <- filter(occ_data, decimalLatitude >= -80)
```

```{r worldclim_data}
## Download current bioclimatic variables
WorldClim_data(period = "current", resolution = 10)

## Enter bioclimatic variables
pred_data <- read_stars(list.files("input_data/WorldClim_data_current/", full.names = T), along = "band", normalize_path = F)
```

```{r study_area}
study_area <- geobr::read_state("PR")
```

```{r create_buffer}
buf <- st_as_sf(occ_data, coords=c(2,3))
buf <- st_buffer(buf, dist=5)
buf <- st_union(buf)
st_crs(buf) <- 4326
```

```{r sdm_area}
sa <- sdm_area(study_area, cell_size = 20000, crs = 6933)
```

```{r add_predictors}
p <- get_predictor_names(sa)
sa <- add_predictors(sa, pred_data)
sa <- select(sa, get_predictor_names(sa)[!get_predictor_names(sa) %in% p])
```

```{r world_clim_future}
## Download current bioclimatic variables
WorldClim_data(path="input_data/WorldClim_data_future/",period = "future", year = c('2050', '2090'), ssp = c('245','585'), resolution = 10)

## Enter bioclimatic variables
scen <- read_stars(list.files("input_data/WorldClim_data_future/", full.names = T), normalize_path = F)

sa <- set_predictor_names(sa, sort(paste0("bio",1:19)))

sa <- add_scenarios(sa, scen)
```

```{r}
# Join occ and sa
oc <- occurrences_sdm(occ_data, crs = 4326) |>
  join_area(sa)
```

```{r input_sdm}
i_sa <- input_sdm(oc, sa)
```

```{r data_clean}
i_sa <- data_clean(i_sa)
```

```{r vif_predictors}
i_sa <- vif_predictors(i_sa)
```

```{r pseudoabsence}
i_sa <- pseudoabsences(i_sa, method = "bioclim", variables_selected = "vif") 
```

```{r train_sdm}
i_sa <- train_sdm(i_sa, algo = c("svmLinear2", "mda", "nnet", "kknn"), variables_selected = "vif")
```

```{r predict_sdm}
i_sa <- predict_sdm(i_sa, th = 0.7)
```

```{r plot_predictions}
plot_predictions(i_sa)
```

```{r pdp_sdm}
pdp_sdm(i_sa)
```

```{r varImp_sdm}
varImp_sdm(i_sa)
```
