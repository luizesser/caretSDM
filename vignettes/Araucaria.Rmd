---
title: "Araucaria"
author: "Luíz Fernando Esser"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Araucaria}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Using polygons as area in caretSDM

`caretSDM` is a under development R package that uses the powerful `caret` package as the main engine to obtain Species Distribution Models. One of its main attributes is the strong geoprocessing underlying its functions. Here we show how to model species distributions using `caretSDM` through the function `sdm_area` with a polygon.

```{r open libraries}
library(caretSDM)
library(stars) # Package used to manipulate GIS data
library(dplyr) # Package to improve data handling
```

## Pre-Processing

### Obtaining example data

We will create some example data. Starting with occurrences and then predictors data. The first one is a function to obtain species data from GBIF, while the second is a function to obtain climatic variables from WorldClim 2.1. You can read more about them by running in the console `?GBIF_data` and `?WorldClim_data`.

```{r GBIF_data}
## Import data from GBIF
occ_data <- GBIF_data('Araucaria angustifolia')

## Remove records from outside the natural occurrence area
occ_data <- filter(occ_data, decimalLongitude >= -64)
occ_data <- filter(occ_data, decimalLongitude <= -36)
occ_data <- filter(occ_data, decimalLatitude <= -10)
occ_data <- filter(occ_data, decimalLatitude >= -80)
```

```{r worldclim_data}
## Download current bioclimatic variables
WorldClim_data(period = "current", resolution = 10)

## Import bioclimatic variables to R
pred_data <- read_stars(list.files("input_data/WorldClim_data_current/", full.names = T), along = "band", normalize_path = F)
```

### The `sdm_area` class

In this package there is a function that groups all the transformations regarding the area to build and project the models. The `sdm_area` function is this function and is also responsible to check CRSs and create a grid to build models. This grid may seem unpurpose for terrestrial ecologists, but is a key element when modeling continental aquatic environments.

```{r study_area, eval=F}
## Download Paraná state boundaries
study_area2 <- geobr::read_state("PR")
```

A possible alternative would be to use a buffer around records to delimitate accessible area.

```{r create_buffer}
## Create a buffer around records
study_area <- occ_data |>
  st_as_sf(coords=c(2,3)) |>
  st_buffer(dist=5) |>
  st_union() |>
  st_as_sf(crs=st_crs(4326))

```

### 

```{r sdm_area}
## Create a sdm_area object
sa <- sdm_area(study_area, cell_size = 20000, crs = 6933)
```

```{r add_predictors}
## Add predictor variables into sdm_area
p <- get_predictor_names(sa)
sa_teste <- add_predictors(sa_teste, pred_data, gdal=F)
sa <- select(sa, get_predictor_names(sa)[!get_predictor_names(sa) %in% p])
```

```{r world_clim_future}
## Download future scenarios
WorldClim_data(path="input_data/WorldClim_data_future/",period = "future", year = c('2050', '2090'), ssp = c('245','585'), resolution = 10)

## Import scenarios to R
scen <- read_stars(list.files("input_data/WorldClim_data_future/", full.names = T), normalize_path = F)

sa <- set_predictor_names(sa, sort(paste0("bio",1:19)))

sa <- add_scenarios(sa, scen)
```

```{r}
# Join occ and sa
oc <- occurrences_sdm(occ_data, crs = 4326) |>
  join_area(sa)
```

### The `input_sdm` class

In this package we will use multiple classes to perform our analysis. Every time we use those objects to perform some kind of analysis, the object will keep the information of what we did. Ideally, the workflow will have only one object throughout it. The `input_sdm` class is the key class in the workflow, where every function will orbitate. That class puts occurrences, predictors, scenarios, models and predictions together to perform analysis that are only possible when two or more of these classes are available. First, we create the object by informing the occurrences, predictors and scenarios classes.

The first class we will use is the occurrences class (*i.e.* "response variable", "target" or "label"). This class receives the occurrence data of the species. But, despite most species data available is presence-only, we consider here in this package that occurrence data is composed of two classes: presences and absences. If absences are not available in species data (which is expected), we will build multiple sets of pseudo-absences to be used in substitution. These datasets will be stored under `occurrences` in `input_sdm`.

Parallel to the `occurrences` class, we will have the `predictors` class to receive the environmental/climatic data (*i.e.* "predictor variables", "covariates", "explanatory variables", "features" or "control variables"). With this class we will perform analysis using only the predictors (such as geoprocessing transformations; `rescaling` argument) and together with the `occurrences` class (such as variable selection routines). It is important to say that this package has a strong geoprocessing background. In this way, it is possible to declare your study area using a shapefile, but also create a new grid over the study area by applying a rescaling method. This can also provide new EPSG to the data to avoid latidudinal convergence.

`input_sdm` function also receives a `scenarios` object, where the researcher can provide new data to project the models. This data can be from future or past scenarios. One can also provide a new `study_area` if the aim of the modeling is to project a model in a new area (*e.g.* as in invasiveness assessments). Lately, when projecting the models, we can include the predictors data as new data to be projected on. This is useful for projecting models in the same region where the model was built.

It is possible to pass multiple classes to the `occurrences`, `predictors` and `scenarios` functions as rasterStacks (from raster package), SpatRaster (from terra package), stars (from stars package), data.frames, simple features (sf package) and others. In this way, if you want to import data to R in your own way and then work them with your favorite package your are able to pass it to `caretSDM` afterwards. We propose here the use of the directory to enter data into caretSDM. By passing the directory to the predictors and scenarios functions, they will recognize data in folder and import it as stars objects (all the processing with geographic data in `caretSDM` is done using `stars` and `sf` packages).

```{r input_sdm}
i_sa <- input_sdm(oc, sa)
```

### Data cleaning routine

```{r data_clean}
i_sa <- data_clean(i_sa)
```

### Removing multicolinearity from predictors' data

```{r vif_predictors}
i_sa <- vif_predictors(i_sa)
```

### Obtaining pseudoabsence data

```{r pseudoabsence}
i_sa <- pseudoabsences(i_sa, method = "bioclim", variables_selected = "vif") 
```

## Processing

### Modeling species relationship with variables

```{r train_sdm}
i_sa <- train_sdm(i_sa, algo = c("svmLinear2", "mda", "nnet", "kknn"), variables_selected = "vif")
```

```{r pdp_sdm}
pdp_sdm(i_sa)
```

```{r varImp_sdm}
varImp_sdm(i_sa)
```

## Post-Processing

### Predicting species distribution in given scenarios

```{r predict_sdm}
i_sa <- predict_sdm(i_sa, th = 0.7)
```

```{r plot_predictions}
plot_predictions(i_sa)
```
