---
title: "caretSDM"
author: "Lu√≠z Fernando Esser"
format: html
editor: visual
---

# caretSDM

`caretSDM` is a under development R package that uses the powerful `caret` package as the main engine to obtain Species Distribution Models. As `caret` is a packaged turned to build machine learning models, `caretSDM` has a strong focus on this approach.

## Installing

First we will install the package from github. For that we will need to install the `devtools` package first and then install the `caretSDM` package.

```{r, eval=F}
install.packages(setdiff("devtools", rownames(installed.packages())))
remotes::install_github('luizesser/caretSDM')
options(timeout = 600)
```

```{r}
library(caretSDM)
library(stars)
library(raster)
library(dplyr)
```

## Pre-Processing

### Obtaining example data

Now we will create some example data. Starting with occurrences and then predictors data. The first one is a function to obtain species data from GBIF, while the second is a function to obtain climatic variables from WorldClim 2.1. You can read more about them by running in the console `?GBIF_data` and `?WorldClim_data`. In this package we will use the following classes to perform our analysis: `occurrences`, `predictors`, `models` and `ensembles`. Every time we use those objects to perform some kind of analysis, the object will keep the information of what we did. Ideally, the workflow will have only one object to each class.

```{r get_data, eval=F}
occ_data <- GBIF_data("Araucaria angustifolia")
# occ_data <- data.frame(sp = rep('Aa', 100), lon = runif(100, min=-180, max=180), lat = runif(100, min=-90, max=90))
pred_data <- WorldClim_data(period = 'current', resolution=10)
```

### The occurrences class

The first class we will use in this tutorial is the occurrences class (*i.e.* "response variable", "target" or "label"). This class receives the occurrence data of the species and its transformations, such as data cleaning. We consider here in this package that occurrence data is composed of two classes: presences and absences. If absences are not available in species data, we will build multiple sets of pseudo-absences to be used in substitution. Those datasets will be stored in the occurrences object.

```{r occurrences, eval=F}
occ <- occurrences(occ_data)
occ
```

**TIP:** pay attention on the information printed above. As we follow this tutorial, information will get richer.

### The predictors class

Parallel to the occurrences class, we will have the predictors class to receive the environmental/climatic data (*i.e.* "predictor variables", "covariates", "explanatory variables", "features" or "control variables"). With this class we will perform analysis using only the predictors (such as geoprocessing transformations) and together with the occurrences class (such as variable selection routines).

```{r predictors, eval=F}
pred <- predictors(pred_data$current)
pred
```

### 

### Data Cleaning

As the first step in our workflow, we will clean our occurrences data by applying a group of functions from the package `CoordinateCleaner`. In this function, we also provide a way to check for environmental duplicates, by including a predictors object. This function also checks for records in the sea if the species is terrestrial, but note that this can be switched off if the studied species is not terrestrial.

```{r data_clean, eval=F}
occ <- data_clean(occ)
occ
```

**TIP:** Note that the information regarding the `occ` object changed. Now it includes the information that we performed a Data Cleaning routine and explicitly informs what methods were used.

### Variable Selection

```{r vif_predictors, eval=F}
pred <- vif_predictors(pred, th=0.5)
pred
```

### Generate Pseudoabsences

As we mentioned before, pseudoabsence data will be stored in the occurrences object. To generate them, you can inform some parameters, but always associated with the predictors data, which will be used to inform environmental information from each pseudoabsence selected. The argument `variables_selected` will inform which variables you want to use to build your pseudoabsences/models. This can either be a vector of variables names or a previously performed selection method.

```{r pseudoabsences, eval=F}
occ <- pseudoabsences(occ, pred, variables_selected='vif')
occ 
```

**TIP:** Note, again, that the information regarding the `occ` object has increased. Now it includes the information that we performed a Data Cleaning routine, explicitly informing what methods were used and the information regarding the pseudoabsences.

## Processing

With the occurrences and predictors data put together, we can pass to the modeling. As the name suggests, this package uses the caret package underlying its modeling procedure. For those who are not familiar, caret is the easiest way to perform Machine Learning analysis in R. It works by setting the modeling arguments, but can provide a lot of automation mostly regarding algorithms fine-tuning.

```{r train_models, warnings = FALSE, message=FALSE, eval=F}
m <- train_sdm(occ, pred, algo=c('svmLinear2', 'fda'))
m
```

Check mean metrics:

```{r model_metrics, eval=F}
m$validation$metrics %>%
     group_by(algo) %>%
     summarise(ROC = mean(ROC), Sensitivity = mean(Sens), Specificity = mean(Spec) )
```

## Post-Processing

```{r predicting_current, eval=F}
p <- predict_sdm(m, pred, th=0.95, tp='prob')
p
```

## Projecting in new scenarios

```{r scenarios, eval=F}
#folder <- "/Users/luizesser/Documents/Mapas/Rasters/WorldClim 2.1/future_5m"
#s <- scenarios(folder, var_select=m$predictors)
#print.scenarios(s)

scenarios_data <- WorldClim_data(period = 'future', year = c('2030', '2090'), ssp = c('126','585'), resolution=10)
folder <- "~/Documents/GitHub/caretSDM/input_data/WorldClim_data_future"
s <- scenarios(folder, var_select=m$predictors)
s
```

```{r projecting_scenarios, warning=FALSE, eval=F}
p2 <- predict_sdm(m, s, th=0.9, tp='prob', ensembles=T)
```

## Mapping

```{r mapping, eval=F, eval=F}
#temp_map <- pred$grid[[1]]
temp_map[] <- p$ensembles[,1]
plot(temp_map)
```

## An alternative:

### The `input_sdm` class

The `input_sdm` class is a alternative that puts occurrences, predictors and scenarios together to perform analysis that are only possible when occurrence and environmental data are available. First, we create the object by informing the occurrences and predictors classes.

```{r input_sdm}
occ_data <- GBIF_data("Araucaria angustifolia", file='input_data/spp_data.csv')
#n <- as.vector(caret::createDataPartition(occ_data$species, list=F))
#train_data <- occ_data[-n,]
#indep_test_data <- occ_data[n,]
#pred_data <- WorldClim_data(period = 'current', resolution=10)
folder_current <- "~/Documents/GitHub/caretSDM/input_data/WorldClim_data_current"
folder_future <- "~/Documents/GitHub/caretSDM/input_data/WorldClim_data_future"
study_area <- st_read('input_data/Brasil/estadosl_2007.shp')
st_crs(study_area) <- st_crs(4326)
#i <- input_sdm(occurrences(x=train_data, independent_test=indep_test_data), 
#               predictors(pred_data$current), 
#               scenarios(folder))
i <- input_sdm(occurrences(occ_data), 
               predictors(folder_current, 
                          study_area = study_area,
                          rescaling=list(cellsize=100000, epsg=6933)), 
               scenarios(folder_future,
                         study_area = study_area,
                         rescaling=list(cellsize=100000, epsg=6933)))

i
```

As previously, we overwrite the previous object with the new object generated by the function:

```{r input_sdm_data_clean}
i <- data_clean(i)
i
```

And, as previous, the object will keep gaining new information and new data. In the case of data_clean, note that now a new method appears at the end of the Data Cleaning information: the Duplicated Cell. This method is only possible when we include the predictors data.

In vif_predictors, now, we are able to perform new methods with the presence of the occurrence data.

```{r input_sdm_vif_predictors}
i <- vif_predictors(i, area='all')
i
```

In the same way as before, we can obtain pseudoabsences.

```{r input_sdm_pseudoabsence}
i <- pseudoabsences(i, method='bioclim', variables_selected='vif')
i
```

We can test if our pseudoabsences are significantly different from the presences by ploting the t-SNE:

```{r tsne}
tsne_sdm(i, selected_vars='vif')
```

Note that, when you are using an algorithm for the first time, caret will ask you to install the relevant packages to properly run the algorithm.

```{r input_sdm_train_parallel, message=FALSE, warning=FALSE}
#i <- train_sdm(i,  algo=list(c('svmLinear2', 'fda'),c('svmLinear2')), #variables_selected='vif')
#i <- train_sdm(i,  algo=c('svmLinear2', 'fda','nnet'), variables_selected='vif')
i <- train_sdm(i,  algo=c('svmLinear2','mda','nnet','nb', 'kknn'), variables_selected='vif')
```

```{r input_sdm_predictions}
i <- predict_sdm(i)
i
```

Generate Maps:

```{r generating_maps}
plot.input_sdm(i)
```
